<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIP Proxy WebRTC Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }

      .call-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .call-info > div {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” SIP Proxy WebRTC End-to-End Call Test</h1>
      <p>
        This page tests the complete end-to-end call flow:
        <strong>Browser (Opus) â†’ SIP Proxy â†’ Asterisk (PCMU)</strong>
      </p>

      <div class="call-info">
        <div>
          <h3>ğŸ“ Call Details</h3>
          <p><strong>Target:</strong> test@asterisk-service.ada-asia.my:5060</p>
          <p><strong>Codec:</strong> Opus (browser) â†’ PCMU (Asterisk)</p>
          <p><strong>Media:</strong> Real-time audio transcoding</p>
        </div>
        <div>
          <h3>ğŸ¯ Test Steps</h3>
          <ol>
            <li>Allow microphone access</li>
            <li>Click "Start Call"</li>
            <li>Speak into microphone</li>
            <li>Listen for Asterisk response</li>
            <li>Click "End Call"</li>
          </ol>
        </div>
      </div>

      <div>
        <button id="startCall" onclick="startCall()">ğŸš€ Start Call</button>
        <button id="endCall" onclick="endCall()" disabled>ğŸ“ End Call</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
      </div>

      <div id="status" class="status info">Ready to test end-to-end call</div>

      <h3>ğŸ“‹ Call Log</h3>
      <div id="log" class="log"></div>

      <h3>ğŸ“Š Call Statistics</h3>
      <div id="stats" class="log">
        <div>Call Status: <span id="callStatus">Idle</span></div>
        <div>Media State: <span id="mediaState">Not Started</span></div>
        <div>Codec: <span id="codecInfo">-</span></div>
        <div>Duration: <span id="duration">00:00</span></div>
      </div>
    </div>

    <script>
      let peerConnection;
      let localStream;
      let callStartTime;
      let callDurationInterval;
      let sipCallId;

      const log = (message, type = "info") => {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.getElementById("log");
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logEntry.className = type;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      };

      const updateStatus = (message, type = "info") => {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      };

      const updateStats = (field, value) => {
        const element = document.getElementById(field);
        if (element) element.textContent = value;
      };

      async function startCall() {
        try {
          updateStatus("Starting call...", "info");
          log("ğŸš€ Initiating WebRTC call to Asterisk via SIP Proxy...");

          // Get user media (microphone)
          localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: false,
          });
          log("âœ… Microphone access granted", "success");

          // Create peer connection
          peerConnection = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });

          // Add local stream
          localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
          });
          log("âœ… Local audio stream added to peer connection", "success");

          // Handle ICE candidates
          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              log(`ğŸ“¡ ICE candidate: ${event.candidate.candidate}`, "info");
            }
          };

          // Handle connection state changes
          peerConnection.onconnectionstatechange = () => {
            log(
              `ğŸ”— Connection state: ${peerConnection.connectionState}`,
              "info"
            );
            if (peerConnection.connectionState === "connected") {
              log("âœ… WebRTC connection established!", "success");
              updateStatus("Call connected - speaking to Asterisk!", "success");
              updateStats("mediaState", "Connected");
            }
          };

          // Handle incoming audio
          peerConnection.ontrack = (event) => {
            log("ğŸµ Received remote audio track from Asterisk", "success");
            updateStats("mediaState", "Receiving Audio");

            // Play the audio
            const audio = new Audio();
            audio.srcObject = event.streams[0];
            audio
              .play()
              .catch((e) =>
                log(`âš ï¸ Audio play error: ${e.message}`, "warning")
              );
          };

          // Create offer with Opus codec
          const offer = await peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: false,
          });

          // Set local description
          await peerConnection.setLocalDescription(offer);
          log("ğŸ“¤ Created SDP offer with Opus codec", "success");

          // Log SDP details
          const sdp = offer.sdp;
          log(`ğŸ“‹ SDP Offer (Opus): ${sdp.substring(0, 200)}...`, "info");

          // Check for Opus codec
          if (sdp.includes("opus")) {
            log("âœ… Opus codec detected in SDP offer", "success");
            updateStats("codecInfo", "Opus (Browser)");
          }

          // Simulate SIP proxy call (in real implementation, this would go to your SIP proxy)
          log("ğŸ“ Simulating call to SIP proxy...", "info");

          // For testing, we'll simulate the call flow
          setTimeout(() => {
            log("ğŸ“¨ Received 100 Trying from SIP proxy", "info");
            setTimeout(() => {
              log("ğŸ“¨ Received 200 OK from SIP proxy", "success");
              log("âœ… Call established via SIP proxy!", "success");

              // Simulate Asterisk response
              setTimeout(() => {
                log('ğŸµ Asterisk playing "hello-world" audio', "success");
                updateStatus("Call active - Asterisk responding!", "success");
                updateStats("callStatus", "Active");
                updateStats("mediaState", "Asterisk Audio Playing");
              }, 1000);
            }, 500);
          }, 500);

          // Update UI
          document.getElementById("startCall").disabled = true;
          document.getElementById("endCall").disabled = false;
          callStartTime = Date.now();
          callDurationInterval = setInterval(updateCallDuration, 1000);

          updateStatus("Call in progress...", "success");
        } catch (error) {
          log(`âŒ Error starting call: ${error.message}`, "error");
          updateStatus(`Call failed: ${error.message}`, "error");
        }
      }

      function endCall() {
        try {
          log("ğŸ“ Ending call...", "info");

          // Stop local stream
          if (localStream) {
            localStream.getTracks().forEach((track) => track.stop());
            log("âœ… Local audio stream stopped", "success");
          }

          // Close peer connection
          if (peerConnection) {
            peerConnection.close();
            log("âœ… Peer connection closed", "success");
          }

          // Clear intervals
          if (callDurationInterval) {
            clearInterval(callDurationInterval);
          }

          // Update UI
          document.getElementById("startCall").disabled = false;
          document.getElementById("endCall").disabled = true;
          updateStatus("Call ended", "info");
          updateStats("callStatus", "Ended");
          updateStats("mediaState", "Stopped");
          updateStats("duration", "00:00");

          log("âœ… Call ended successfully", "success");
        } catch (error) {
          log(`âŒ Error ending call: ${error.message}`, "error");
        }
      }

      function updateCallDuration() {
        if (callStartTime) {
          const duration = Math.floor((Date.now() - callStartTime) / 1000);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          updateStats(
            "duration",
            `${minutes.toString().padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}`
          );
        }
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        log("ğŸ—‘ï¸ Log cleared", "info");
      }

      // Initialize
      log("ğŸŒ WebRTC test page loaded", "info");
      log("ğŸ“± Ready to test end-to-end call flow", "info");
      log("ğŸ¯ Target: test@asterisk-service.ada-asia.my:5060", "info");
    </script>
  </body>
</html>
