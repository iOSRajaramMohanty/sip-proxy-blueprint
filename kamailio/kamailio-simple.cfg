# Simplified Kamailio SIP Server Configuration
# Compatible with cloudonix/kamailio:latest image

####### Global Parameters #########
debug=2
log_stderror=no
log_facility=LOG_LOCAL0

/* number of children processes */
children=4

/* listen addresses */
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060

/* add local domain aliases */
alias="localhost"

/* log prefix */
log_prefix="{$mt $hdr(CSeq) $ci} "

/* disable memory debugging */
# memdbg=5

/* check the mempool size */
# mempool_size=2048

####### Modules Section ########
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"

####### Routing Logic ########

/* Main SIP request routing logic */
request_route {
    /* initial sanity checks */
    if (is_method("OPTIONS") && uri==myself) {
        sl_send_reply("200", "Keepalive");
        exit;
    }
    
    /* handle requests */
    if (is_method("REGISTER")) {
        route(REGISTER);
        exit;
    }
    
    if (is_method("INVITE")) {
        route(INVITE);
        exit;
    }
    
    if (is_method("ACK")) {
        route(RELAY);
        exit;
    }
    
    if (is_method("BYE")) {
        route(RELAY);
        exit;
    }
    
    if (is_method("CANCEL")) {
        route(RELAY);
        exit;
    }
    
    /* forward other requests */
    route(RELAY);
}

route[REGISTER] {
    if (!save("location")) {
        sl_reply_error("500", "Internal Error");
        exit;
    }
    sl_send_reply("200", "OK");
}

route[INVITE] {
    if (!lookup("location")) {
        sl_send_reply("404", "Not Found");
        exit;
    }
    route(RELAY);
}

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error("500", "Internal Error");
    }
} 